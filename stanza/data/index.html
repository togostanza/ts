{{.HeaderHtml}}<script src="../assets/components/jquery/dist/jquery.min.js"></script>
<script src="../assets/components/handlebars/handlebars.min.js"></script>
<script>
(function(descriptor) {
  function Stanza(execute) {
    var proto = Object.create(HTMLElement.prototype);

    function createStanzaHelper(element) {
      return {
        query: function(params) {
          var queryTemplate = Handlebars.compile(descriptor.templates[params.template], {noEscape: true});
          var query = queryTemplate(params.parameters);

          return $.ajax({
            url: params.endpoint,
            data: {
              format: "json",
              query: query
            }
          }).then(function(data) {
            var rows = data.results.bindings.map(function(row) {
              var rowOut = {};
              Object.keys(row).forEach(function(key) {
                rowOut[key] = row[key].value;
              });
              return rowOut;
            });

            return rows;
          });
        },
        render: function(params) {
          var htmlTemplate = Handlebars.compile(descriptor.templates[params.template]);
          var htmlPartial = htmlTemplate(params.parameters);
          var selector = params.selector || "main";
          $(selector, element.shadowRoot).html(htmlPartial);
        }
      };
    }

    function update(element) {
      var params = {};
      descriptor.parameters.forEach(function(key) {
        params[key] = element.getAttribute(key);
      });
      execute(createStanzaHelper(element), params);
    }

    proto.createdCallback = function() {
      var shadow = this.createShadowRoot();

      var style = document.createElement("style");
      style.appendChild(document.createTextNode(descriptor.stylesheet));
      shadow.appendChild(style);
      var main = document.createElement("main");
      shadow.appendChild(main);

      update(this);
    };

    proto.attributeChangedCallback = function(attrName, oldVal, newVal) {
      update(this);
    };

    document.registerElement(descriptor.elementName, {
      prototype: proto
    });
  };

  {{.IndexJs}}
})({{.DescriptorJson}});
</script>
